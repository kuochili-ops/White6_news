<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğ“ƒ¥ ç™½å…­æ—¥å ± - v14.0</title>
    <style>
        body { 
            background: #1a1a1a; 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh;
            font-family: sans-serif;
        }

        /* åˆå§‹ç‹€æ…‹ï¼šåªé¡¯ç¤ºé€™å€‹å¤§å€åŸŸ */
        #init-upload-zone {
            width: 90%;
            max-width: 400px;
            padding: 40px 20px;
            border: 3px dashed #f39c12;
            border-radius: 20px;
            text-align: center;
            background: #222;
        }

        .big-input {
            width: 100%;
            height: 80px;
            font-size: 1.2rem;
            margin-top: 20px;
            background: #fff;
            color: #000;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
        }

        /* éš±è—å¾ŒçºŒæ‰€æœ‰å…§å®¹ */
        #newspaper-content { display: none; width: 100%; padding: 20px 0; }
        
        /* ç·¨è¼¯ä»‹é¢èˆ‡å ±ç´™æ¨£å¼ç°¡åŒ– */
        .viewport { width: 200px; height: 200px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #000; touch-action: none; }
        .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); transform-origin: center center; }
        .paper-base { 
            width: 440px; 
            background: #dbd0bc; 
            color: #2a2825; 
            padding: 25px; 
            margin: 20px auto;
            box-sizing: border-box;
            font-family: 'serif';
        }
        .btn-pub { background: #27ae60; color: white; padding: 15px; width: 90%; border: none; font-size: 1.2rem; font-weight: bold; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="init-upload-zone">
        <h2 style="margin:0;">ğ“ƒ¥ ç™½å…­æ—¥å ±ç³»çµ±</h2>
        <p style="color: #aaa;">è«‹å…ˆé¸å–ä»Šæ—¥ç…§ç‰‡ä»¥é–‹å•Ÿç·¨è¼¯å™¨</p>
        <input type="file" id="main-upload" accept="image/*" class="big-input">
    </div>

    <div id="newspaper-content">
        <div style="text-align:center; background:#333; padding:20px; margin:0 10px; border-radius:15px;">
            <h3>ğŸ¨ èª¿æ•´ç…§ç‰‡ä½ç½®èˆ‡å¤§å°</h3>
            <div class="viewport" id="v-frame">
                <img id="edit-img" class="sync-img" src="">
            </div>
            <input type="range" id="zoom-bar" min="0.1" max="4" step="0.01" value="1" style="width: 80%;">
            <br>
            <button class="btn-pub" onclick="startPublish()" id="pub-btn">ç¢ºèªä¸¦åˆŠå°ç™¼å¸ƒ</button>
        </div>

        <div class="paper-base" id="capture-area">
            <h1 style="text-align:center; font-size:3rem; margin:0; border-bottom:4px solid #2a2825;">ç™½å…­æ—¥å ±</h1>
            <div style="display:flex; margin-top:20px;">
                <div style="flex:1; padding-right:15px; border-right:1px solid #2a2825;">
                    <p><b>ä»Šæ—¥é ­æ¢ï¼š</b> å ±ç´™ç³»çµ±æ›´æ–° v14.0 ç©©å®šç‰ˆï¼Œä¿®å¾©äº†æ‰‹æ©Ÿç«¯é»æ“Šæ¬Šé™è¡çªå•é¡Œ...</p>
                </div>
                <div style="width:160px; padding-left:15px;">
                    <div style="width:100%; height:160px; border:1px solid #000; overflow:hidden; position:relative;">
                        <img id="paper-img" class="sync-img" src="">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const TK_PARTS = ["ghp_CbTbFJpfe9j2u0ER", "U80NwlkHv5NJVQ23vKXE"];
        const GH_CONFIG = { owner: "kuochili-ops", repo: "White6_news", path: "images/daily.jpg" };

        let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;
        const mainUpload = document.getElementById('main-upload');
        const editImg = document.getElementById('edit-img');
        const paperImg = document.getElementById('paper-img');
        const initZone = document.getElementById('init-upload-zone');
        const content = document.getElementById('newspaper-content');

        // ç›£è½é¸å–ç…§ç‰‡
        mainUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                // 1. æ³¨å…¥åœ–ç‰‡
                editImg.src = paperImg.src = ev.target.result;
                
                // 2. åˆ‡æ›ä»‹é¢ï¼šéš±è—æŒ‰éˆ•å€ï¼Œé¡¯ç¤ºå ±ç´™å…§å®¹
                initZone.style.display = 'none';
                content.style.display = 'block';
                
                // 3. åˆå§‹åŒ–ä½ç½®
                scale = 1; posX = 0; posY = 0;
                refresh();
            };
            reader.readAsDataURL(file);
        };

        function refresh() {
            const t = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
            editImg.style.transform = paperImg.style.transform = t;
        }

        document.getElementById('zoom-bar').oninput = (e) => { scale = e.target.value; refresh(); };

        const vFrame = document.getElementById('v-frame');
        vFrame.ontouchstart = (e) => { isDragging = true; startX = e.touches[0].clientX - posX; startY = e.touches[0].clientY - posY; };
        window.ontouchmove = (e) => { if (!isDragging) return; posX = e.touches[0].clientX - startX; posY = e.touches[0].clientY - startY; refresh(); };
        window.ontouchend = () => isDragging = false;

        async function startPublish() {
            const btn = document.getElementById('pub-btn');
            btn.innerText = "â³ ç™¼å¸ƒä¸­...";
            try {
                const canvas = await html2canvas(document.getElementById('capture-area'), { useCORS: true });
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`;
                const res = await fetch(url);
                let sha = res.ok ? (await res.json()).sha : null;
                const put = await fetch(url, { 
                    method: "PUT", 
                    headers: { "Authorization": `token ${TK_PARTS.join('')}`, "Content-Type": "application/json" }, 
                    body: JSON.stringify({ message: "Update", content: b64, sha }) 
                });
                if (put.ok) alert("âœ… åˆŠå°å®Œæˆï¼");
            } catch (e) { alert("ç™¼ç”ŸéŒ¯èª¤"); }
            btn.innerText = "ç¢ºèªä¸¦åˆŠå°ç™¼å¸ƒ";
        }
    </script>
</body>
</html>
