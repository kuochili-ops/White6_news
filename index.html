<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğ“ƒ¥ ç™½å…­æ—¥å ± - v14.1</title>
    <style>
        body { background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; padding-top: 50px; font-family: sans-serif; }
        
        /* å”¯ä¸€çš„æŒ‰éˆ•ï¼šå¼·åˆ¶æ”¾åœ¨æœ€å‰é¢ */
        .big-input { 
            width: 90%; height: 120px; font-size: 24px; 
            background: white; color: black; border: 8px solid #f39c12; 
            border-radius: 20px; font-weight: bold; position: relative; z-index: 9999;
        }

        #editor-ui { display: none; width: 100%; text-align: center; margin-top: 20px; }
        .viewport { width: 200px; height: 200px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #000; touch-action: none; }
        .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); transform-origin: center center; }
        .btn-pub { background: #27ae60; color: white; padding: 20px; width: 90%; border: none; font-size: 1.2rem; font-weight: bold; border-radius: 10px; margin-top: 20px; }
        
        /* å ±ç´™åº•ç¨¿æ¨£å¼ï¼šåˆå§‹éš±è— */
        #newspaper-area { display: none; width: 440px; background: #dbd0bc; color: #2a2825; padding: 20px; margin-top: 30px; }
    </style>
</head>
<body>

    <div id="step-1-container">
        <h2 id="msg">æ­¥é©Ÿ 1ï¼šè«‹é»ä¸‹æ–¹é–‹å•Ÿç…§ç‰‡</h2>
        <input type="file" id="upload" accept="image/*" class="big-input">
    </div>

    <div id="editor-ui">
        <h2>æ­¥é©Ÿ 2ï¼šèª¿æ•´ä½ç½®èˆ‡å¤§å°</h2>
        <div class="viewport" id="v-frame">
            <img id="edit-img" class="sync-img" src="">
        </div>
        <input type="range" id="zoom-ctrl" min="0.1" max="4" step="0.01" value="1" style="width: 80%;">
        <br>
        <button class="btn-pub" onclick="doUpload()">ç¢ºå®šåˆŠå°ç™¼å¸ƒ</button>
        
        <div id="newspaper-area">
            <h1 style="border-bottom:3px solid #000; margin:0; font-size:3rem;">ç™½å…­æ—¥å ±</h1>
            <div style="display:flex; margin-top:15px;">
                <div style="flex:1; text-align:left; border-right:1px solid #000; padding-right:10px;" id="news-box">è¼‰å…¥æ–°èä¸­...</div>
                <div style="width:160px; padding-left:10px;">
                    <div id="p-box" style="width:100%; height:160px; overflow:hidden; position:relative; border:1px solid #000;">
                        <img id="final-img" class="sync-img" src="">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
        const CONF = { owner: "kuochili-ops", repo: "White6_news", path: "images/daily.jpg" };

        const upload = document.getElementById('upload');
        const editor = document.getElementById('editor-ui');
        const editImg = document.getElementById('edit-img');
        const finalImg = document.getElementById('final-img');
        const zoom = document.getElementById('zoom-ctrl');

        let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;

        // æ ¸å¿ƒï¼šç›£è½ä¸Šå‚³
        upload.onchange = function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    editImg.src = finalImg.src = ev.target.result;
                    document.getElementById('step-1-container').style.display = 'none';
                    editor.style.display = 'block';
                    document.getElementById('newspaper-area').style.display = 'block';
                    // é †ä¾¿æŠ“æ–°è
                    fetchNews();
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        // ç¸®æ”¾èˆ‡æ‹–æ›³é‚è¼¯
        function update() {
            const t = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
            editImg.style.transform = finalImg.style.transform = t;
        }

        zoom.oninput = () => { scale = zoom.value; update(); };

        const vFrame = document.getElementById('v-frame');
        vFrame.ontouchstart = (e) => { isDragging = true; startX = e.touches[0].clientX - posX; startY = e.touches[0].clientY - posY; };
        window.ontouchmove = (e) => { if(!isDragging) return; posX = e.touches[0].clientX - startX; posY = e.touches[0].clientY - startY; update(); };
        window.ontouchend = () => isDragging = false;

        async function doUpload() {
            const btn = event.target;
            btn.innerText = "â³ åˆŠå°ä¸­...";
            try {
                const canvas = await html2canvas(document.getElementById('p-box'));
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/${CONF.owner}/${CONF.repo}/contents/${CONF.CONF_path || CONF.path}`;
                const get = await fetch(url);
                const sha = get.ok ? (await get.json()).sha : null;
                await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update", content: b64, sha })
                });
                alert("âœ… åˆŠå°æˆåŠŸï¼");
                location.reload();
            } catch (e) { alert("éŒ¯èª¤"); btn.innerText = "ç¢ºå®šåˆŠå°ç™¼å¸ƒ"; }
        }

        function fetchNews() {
            fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=zh-TW%26gl=TW%26ceid=TW:zh-Hant')
            .then(r => r.json()).then(d => {
                document.getElementById('news-box').innerHTML = d.items.slice(0, 3).map(i => `<p style="font-size:12px;margin:5px 0;">â€¢ ${i.title.split(' - ')[0]}</p>`).join('');
            });
        }
    </script>
</body>
</html>
