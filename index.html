<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğ“ƒ¥ ç™½å…­æ—¥å ± - v17.4 æ——è‰¦è§¸æ§ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
        :root { --paper: #dbd0bc; --ink: #2a2825; --accent: #7a0000; --ui-bg: #1a1a1a; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }
        body { background: var(--ui-bg); margin: 0; font-family: 'Noto Serif TC', serif; color: #fff; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* ç·¨è¼¯å€åŸŸ */
        .editor-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; position: relative; }
        .viewport { 
            width: 300px; height: 300px; border: 2px solid rgba(255,255,255,0.3); 
            background: #000; position: relative; overflow: hidden; border-radius: 8px;
        }
        .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); pointer-events: none; }
        .touch-hint { font-size: 0.8rem; color: #888; margin-top: 10px; }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        .bottom-panel { 
            background: rgba(34,34,34,0.95); padding: 20px 20px calc(20px + env(safe-area-inset-bottom));
            border-top: 1px solid #444; z-index: 1000;
        }
        .input-box { width: 100%; height: 45px; background: #333; border: 1px solid #555; color: #fff; border-radius: 8px; padding: 0 15px; margin-bottom: 15px; font-size: 16px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; height: 55px; border: none; border-radius: 12px; font-weight: 900; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-album { background: #444; color: #fff; }
        .btn-pub { background: #f39c12; color: #000; }

        /* å ±ç´™éš±è—å®¹å™¨ (æˆªåœ–ç”¨) */
        #paper-master { position: fixed; left: -9999px; top: 0; }
        #paper { width: 500px; background: var(--paper); color: var(--ink); padding: 30px; }
        header { border-top: 6px solid var(--ink); border-bottom: 2px solid var(--ink); margin-bottom: 20px; text-align: center; }
        .newspaper-title { font-size: 4.2rem; font-weight: 900; letter-spacing: 12px; margin: 5px 0; }
        .date-line { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 900; }
        
        .layout-grid { display: flex; border-bottom: 3.5px solid var(--ink); padding-bottom: 20px; }
        .left-col { width: 280px; padding-right: 20px; border-right: 2px solid var(--ink); }
        .right-col { width: 160px; padding-left: 20px; text-align: center; }

        .section-h { font-size: 1.1rem; border-bottom: 2px solid var(--ink); margin-bottom: 10px; font-weight: 900; text-align: left; }
        .news-item { font-size: 0.85rem; line-height: 1.5; margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 8px; text-align: justify; font-weight: 700; }

        .city-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #888; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; }
        .p-frame { width: 240px; height: 240px; border: 1.5px solid var(--ink); margin: 0 auto; overflow: hidden; position: relative; background: #fff; }
        .n-greet { font-size: 2.2rem; font-weight: 900; writing-mode: vertical-rl; margin: 10px auto; color: var(--accent); height: 140px; }
        #daily-q { font-size: 1.1rem; font-weight: 900; color: var(--accent); border: 2.5px solid var(--accent); padding: 8px; margin-top: 10px; line-height: 1.3; }
    </style>
</head>
<body>

    <div class="editor-container">
        <div class="viewport" id="vf">
            <img id="img-e" class="sync-img" src="">
            <div id="hint" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#555;">å°šæœªé¸å–ç…§ç‰‡</div>
        </div>
        <div class="touch-hint">ğŸ‘‹ å–®æŒ‡æ‹–æ›³ ï½œ âœŒï¸ å…©æŒ‡ç¸®æ”¾</div>
    </div>

    <div class="bottom-panel">
        <input type="text" id="cap-in" class="input-box" placeholder="è¼¸å…¥åœ–èªª (ä¾‹: å¤§å¥½æ—¥å­)">
        <div class="btn-group">
            <button class="btn btn-album" onclick="document.getElementById('upload').click()">ğŸ–¼ï¸ é¸æ“‡ç›¸ç‰‡</button>
            <button class="btn btn-pub" id="pub-btn">ğŸš€ åˆŠå°ç™¼å¸ƒ</button>
        </div>
        <input type="file" id="upload" accept="image/*" style="display:none">
    </div>

    <div id="paper-master">
        <div id="paper">
            <header>
                <div class="date-line"><span>æ­²æ¬¡ ä¹™å·³å¹´ åä¸€æœˆ</span><span id="p-date">2026å¹´1æœˆ7æ—¥</span></div>
                <h1 class="newspaper-title">ç™½å…­æ—¥å ±</h1>
            </header>
            <div class="layout-grid">
                <div class="left-col">
                    <div class="section-h">ä»Šæ—¥é ­æ¢æ–°è</div>
                    <div id="news-list">è¼‰å…¥æ–°èä¸­...</div>
                    <div class="section-h" style="margin-top:15px;">å…¨å°å„åœ°æ°£æº«</div>
                    <div id="weather-grid"></div>
                </div>
                <div class="right-col">
                    <div class="p-frame"><img id="img-p" class="sync-img" src=""></div>
                    <div id="out-cap" style="font-size:0.8rem; font-weight:bold; margin:8px 0;">ä»Šæ—¥å½±åƒç´€éŒ„</div>
                    <div id="daily-q" onclick="changeQuote()">å¿ƒè‹¥é™½å…‰<br>ç„¡æ‡¼é¢¨é›¨</div>
                    <div class="n-greet" id="p-greet">åˆå®‰</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
        let state = { x: 0, y: 0, s: 1, lastD: 0 };
        let touches = {};
        const quotes = ["å¿ƒè‹¥é™½å…‰<br>ç„¡æ‡¼é¢¨é›¨", "æ­²æœˆéœå¥½<br>ç¾ä¸–å®‰ç©©", "ä¸å¿˜åˆå¿ƒ<br>æ–¹å¾—å§‹çµ‚", "è¬ç‰©æœ‰éˆ<br>çš†æœ‰æº«æš–", "æ—¥æ—¥æ˜¯å¥½æ—¥"];

        // 1. å¼·åŒ–è§¸æ§é‚è¼¯ (Pointer Events)
        const vf = document.getElementById('vf');
        const update = () => {
            const t = `translate(calc(-50% + ${state.x}px), calc(-50% + ${state.y}px)) scale(${state.s})`;
            document.getElementById('img-e').style.transform = document.getElementById('img-p').style.transform = t;
        };

        vf.addEventListener('pointerdown', e => { touches[e.pointerId] = e; vf.setPointerCapture(e.pointerId); });
        vf.addEventListener('pointermove', e => {
            if (!touches[e.pointerId]) return;
            touches[e.pointerId] = e;
            const keys = Object.keys(touches);
            if (keys.length === 1) {
                state.x += e.movementX; state.y += e.movementY;
            } else if (keys.length === 2) {
                const p1 = touches[keys[0]], p2 = touches[keys[1]];
                const d = Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY);
                if (state.lastD) state.s *= (d / state.lastD);
                state.lastD = d;
            }
            update();
        });
        vf.addEventListener('pointerup', e => { delete touches[e.pointerId]; state.lastD = 0; });

        // 2. ç›¸ç°¿èˆ‡åŠŸèƒ½é€£å‹•
        document.getElementById('upload').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('img-e').src = document.getElementById('img-p').src = ev.target.result;
                document.getElementById('hint').style.display = 'none';
                initData();
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('cap-in').oninput = (e) => {
            document.getElementById('out-cap').innerText = e.target.value || "ä»Šæ—¥å½±åƒç´€éŒ„";
        };

        function changeQuote() {
            document.getElementById('daily-q').innerHTML = quotes[Math.floor(Math.random()*quotes.length)];
        }

        // 3. æ•¸æ“šåˆå§‹åŒ– (æ°£è±¡èˆ‡æ–°è)
        async function initData() {
            const now = new Date();
            document.getElementById('p-date').innerText = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            const hr = now.getHours();
            document.getElementById('p-greet').innerText = (hr<11)?"æ—©å®‰":(hr<17)?"åˆå®‰":"æ™šå®‰";

            // æ¨¡æ“¬æ°£è±¡ (åŸºæ–¼ä¹‹å‰çš„é‚è¼¯)
            const cities = ["å°åŒ— â˜€ï¸","å°ä¸­ â›…","é«˜é›„ â˜€ï¸","å®œè˜­ ğŸŒ§ï¸","èŠ±è“® â›…"];
            document.getElementById('weather-grid').innerHTML = cities.map(c => `<div class="city-row"><span>${c}</span><b>18~22Â°</b></div>`).join('');

            // æŠ“å–æ–°è
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=zh-TW%26gl=TW%26ceid=TW:zh-Hant`);
                const d = await res.json();
                document.getElementById('news-list').innerHTML = d.items.slice(0, 4).map(i => `<div class="news-item">${i.title.split(' - ')[0]}</div>`).join('');
            } catch(e) {}
        }

        // 4. ç™¼å¸ƒåŠŸèƒ½
        document.getElementById('pub-btn').onclick = async function() {
            if(!document.getElementById('img-e').src) return alert("è«‹å…ˆé¸å–ç…§ç‰‡");
            const btn = this;
            btn.innerText = "â³ åˆŠå°ä¸­...";
            try {
                const canvas = await html2canvas(document.getElementById('paper'), { scale: 2, backgroundColor: "#dbd0bc" });
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                const res = await fetch(url);
                const sha = res.ok ? (await res.json()).sha : null;
                await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Daily Update", content: b64, sha })
                });
                alert("âœ… åˆŠå°æˆåŠŸï¼å·²åŒæ­¥è‡³é›²ç«¯ã€‚");
            } catch (e) { alert("åˆŠå°å¤±æ•—"); }
            btn.innerText = "ğŸš€ åˆŠå°ç™¼å¸ƒ";
        };

        window.onload = initData;
    </script>
</body>
</html>
