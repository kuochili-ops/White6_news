<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™½å…­æ—¥å ± v15.0</title>
</head>
<body style="background:#000; color:#fff; text-align:center; margin:0; padding-top:100px; font-family:sans-serif;">

    <div id="init-box">
        <h1 style="color:#f39c12;">ğ“ƒ¥ ç™½å…­æ—¥å ±ç³»çµ±</h1>
        <p>è«‹é»æ“Šä¸‹æ–¹ç™½è‰²å€åŸŸé¸å–ç…§ç‰‡ï¼š</p>
        <input type="file" id="up" accept="image/*" style="display:block; width:80%; height:100px; margin:20px auto; background:#fff; color:#000; font-size:20px; font-weight:bold; border:5px solid #f39c12; border-radius:15px;">
    </div>

    <div id="app-body" style="width:100%; max-width:440px; margin:0 auto; display:none;"></div>

    <script>
        const fileInput = document.getElementById('up');
        
        // 1. å¼·åŠ›ç›£è½æª”æ¡ˆé¸å–
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(ev) {
                // é¸åœ–æˆåŠŸå¾Œï¼Œç«‹åˆ»åˆ‡æ› UI ä¸¦æ³¨å…¥åŠŸèƒ½
                initRealApp(ev.target.result);
            };
            reader.readAsDataURL(file);
        }, false);

        function initRealApp(imgData) {
            // éš±è—åˆå§‹ç•«é¢
            document.getElementById('init-box').style.display = 'none';
            const body = document.getElementById('app-body');
            body.style.display = 'block';

            // 2. å»¶é²æ³¨å…¥ CSS
            const style = document.createElement('style');
            style.innerHTML = `
                @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@900&display=swap');
                body { background: #1a1a1a !important; padding: 10px !important; }
                .edit-ui { background: #333; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
                .viewport { width: 180px; height: 180px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #000; touch-action: none; }
                .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); transform-origin: center center; }
                .paper { width: 440px; background: #dbd0bc; color: #2a2825; padding: 25px; box-sizing: border-box; font-family: 'Noto Serif TC', serif; text-align: left; }
                .btn-pub { background: #27ae60; color: white; padding: 18px; width: 100%; border: none; font-size: 1.2rem; font-weight: bold; border-radius: 10px; margin-top: 15px; }
            `;
            document.head.appendChild(style);

            // 3. æ³¨å…¥åŠŸèƒ½çµæ§‹
            body.innerHTML = `
                <div class="edit-ui">
                    <b style="color:#f39c12">â¶ èª¿æ•´å½±åƒèˆ‡åœ–èªª</b>
                    <div class="viewport" id="v-frame">
                        <img id="img-e" class="sync-img" src="${imgData}">
                    </div>
                    <input type="range" id="zoom" min="0.05" max="3" step="0.01" value="1" style="width: 80%; height: 40px;">
                    <input type="text" id="cap-in" placeholder="åœ¨æ­¤è¼¸å…¥åœ–èªª..." style="width:100%; padding:12px; margin-top:10px; box-sizing:border-box;">
                    <button class="btn-pub" id="final-btn">â· ç¢ºå®šåˆŠå°ç™¼å¸ƒ</button>
                </div>
                <div class="paper" id="capture-area">
                    <h1 style="font-size:3.5rem; font-weight:900; letter-spacing:10px; margin:0; border-bottom:4px solid #000; text-align:center;">ç™½å…­æ—¥å ±</h1>
                    <div style="display:flex; margin-top:15px; border-bottom:2px solid #000; padding-bottom:15px;">
                        <div id="news-box" style="flex:1; border-right:1.5px solid #000; padding-right:15px; font-size:0.85rem;">è¼‰å…¥ä»Šæ—¥è¦è...</div>
                        <div style="width:140px; padding-left:15px; text-align:center;">
                            <div style="width:140px; height:140px; border:1px solid #000; overflow:hidden; position:relative;">
                                <img id="img-p" class="sync-img" src="${imgData}">
                            </div>
                            <div id="p-cap-out" style="font-size:0.7rem; font-weight:bold; margin-top:5px;">ä»Šæ—¥å½±åƒ</div>
                            <div style="font-size:1.6rem; font-weight:900; color:#7a0000; border:1px solid #7a0000; margin-top:10px; padding:5px;">åˆå®‰Â·èˆ’å¿ƒ</div>
                        </div>
                    </div>
                </div>
            `;

            // 4. åŠ è¼‰æˆªåœ–å·¥å…·
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            document.head.appendChild(script);

            // 5. å•Ÿå‹•äº¤äº’è…³æœ¬
            setupAppLogic();
        }

        function setupAppLogic() {
            let scale = 1, posX = 0, posY = 0, isDrag = false, sx, sy;
            const imgE = document.getElementById('img-e'), imgP = document.getElementById('img-p');
            const zoom = document.getElementById('zoom');
            
            const update = () => {
                const t = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
                imgE.style.transform = imgP.style.transform = t;
            };

            zoom.oninput = () => { scale = zoom.value; update(); };
            document.getElementById('cap-in').oninput = (e) => { 
                document.getElementById('p-cap-out').innerText = e.target.value || "ä»Šæ—¥å½±åƒ"; 
            };

            const v = document.getElementById('v-frame');
            v.ontouchstart = (e) => { isDrag = true; sx = e.touches[0].clientX - posX; sy = e.touches[0].clientY - posY; };
            window.ontouchmove = (e) => { if(!isDrag) return; posX = e.touches[0].clientX - sx; posY = e.touches[0].clientY - sy; update(); };
            window.ontouchend = () => isDrag = false;

            // æŠ“å–æ–°è
            fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=zh-TW%26gl=TW%26ceid=TW:zh-Hant')
            .then(r => r.json()).then(d => {
                document.getElementById('news-box').innerHTML = d.items.slice(0, 5).map(i => `<p style="margin:5px 0;">â€¢ ${i.title.split(' - ')[0]}</p>`).join('');
            });

            // åˆŠå°æŒ‰éˆ•
            document.getElementById('final-btn').onclick = async function() {
                this.innerText = "â³ åˆŠå°ä¸­...";
                const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
                try {
                    const canvas = await html2canvas(document.getElementById('capture-area'), { useCORS: true, scale: 2 });
                    const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                    const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                    const get = await fetch(url);
                    const sha = get.ok ? (await get.json()).sha : null;
                    await fetch(url, { method: "PUT", headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" }, body: JSON.stringify({ message: "Update", content: b64, sha }) });
                    alert("âœ… åˆŠå°æˆåŠŸï¼");
                } catch (e) { alert("ç™¼å¸ƒå¤±æ•—"); }
                this.innerText = "â· ç¢ºå®šåˆŠå°ç™¼å¸ƒ";
            };
        }
    </script>
</body>
</html>
