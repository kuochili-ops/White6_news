<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğ“ƒ¥ ç™½å…­æ—¥å ± v14.8</title>
</head>
<body style="background:#1a1a1a; color:#fff; text-align:center; margin:0; font-family:sans-serif; min-height:100vh; display:flex; flex-direction:column; align-items:center;">

    <div id="init-box" style="margin-top:100px; padding:30px; border:4px solid #f39c12; border-radius:20px; background:#222; width:80%;">
        <h1 style="color:#f39c12; margin:0 0 10px 0;">ğ“ƒ¥ ç™½å…­æ—¥å ±</h1>
        <p style="color:#ccc;">è«‹é–‹å•Ÿä»Šæ—¥å½±åƒä»¥å•Ÿå‹•ç·¨è¼¯ï¼š</p>
        <input type="file" id="up" accept="image/*" style="width:100%; height:80px; background:#fff; color:#000; font-size:1.2rem; font-weight:bold; border-radius:10px; margin-top:10px;">
    </div>

    <div id="app-body" style="width:100%; max-width:440px;"></div>

    <script>
        const input = document.getElementById('up');
        input.onchange = function(e) {
            if(!e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(ev) { startApp(ev.target.result); };
            reader.readAsDataURL(e.target.files[0]);
        };

        function startApp(imgSrc) {
            document.getElementById('init-box').style.display = 'none';

            const style = document.createElement('style');
            style.innerHTML = `
                @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
                body { background: #1a1a1a; padding: 10px; font-family: 'Noto Serif TC', serif; }
                .edit-panel { background: #333; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #555; }
                /* ç·¨è¼¯å€åŸŸç¶­æŒè¼ƒå¤§æ–¹ä¾¿æ“ä½œ */
                .viewport { width: 180px; height: 180px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #000; touch-action: none; }
                .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); transform-origin: center center; pointer-events: none; }
                .paper { width: 440px; background: #dbd0bc; color: #2a2825; padding: 25px; box-sizing: border-box; background-image: url('https://www.transparenttextures.com/patterns/pinstriped-suit.png'); text-align: left; }
                .btn { background: #27ae60; color: white; padding: 18px; width: 100%; border: none; font-size: 1.2rem; font-weight: bold; border-radius: 10px; margin-top: 15px; }
                .news-item { font-size: 0.82rem; line-height: 1.4; margin-bottom: 8px; border-left: 3px solid #7a0000; padding-left: 8px; font-weight: 700; }
            `;
            document.head.appendChild(style);

            document.getElementById('app-body').innerHTML = `
                <div class="edit-panel">
                    <b style="color:#f39c12">â¶ èª¿æ•´å½±åƒ (æ»‘æ¡¿å¯ç¸®æ”¾)</b>
                    <div class="viewport" id="v-frame">
                        <img id="img-e" class="sync-img" src="${imgSrc}">
                    </div>
                    <input type="range" id="zoom" min="0.05" max="3" step="0.01" value="1" style="width: 80%;">
                    <input type="text" id="cap-in" placeholder="è¼¸å…¥åœ–èªª..." style="width:100%; padding:10px; margin-top:10px; box-sizing:border-box;">
                    <button class="btn" onclick="publish()">â· ç¢ºå®šåˆŠå°ç™¼å¸ƒ</button>
                </div>
                <div class="paper" id="post-area">
                    <header style="border-top:5px solid #2a2825; border-bottom:2px solid #2a2825; margin-bottom:15px; text-align:center;">
                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:bold;">
                            <span>æ­²æ¬¡ ä¹™å·³å¹´</span><span id="p-date"></span>
                        </div>
                        <h1 style="font-size:3.5rem; font-weight:900; letter-spacing:10px; margin:5px 0;">ç™½å…­æ—¥å ±</h1>
                    </header>
                    <div style="display:flex; border-bottom:2.5px solid #2a2825; padding-bottom:15px;">
                        <div id="p-news" style="flex: 1; padding-right:15px; border-right:1.5px solid #2a2825;">æ–°èè¼‰å…¥ä¸­...</div>
                        
                        <div style="width:140px; padding-left:15px;">
                            <div id="p-box" style="width:100%; height:140px; border:1px solid #2a2825; overflow:hidden; position:relative; background:#e0d8c8;">
                                <img id="img-p" class="sync-img" src="${imgSrc}">
                            </div>
                            <div id="p-cap-out" style="font-size:0.7rem; text-align:center; font-weight:bold; margin-top:5px;">ä»Šæ—¥å½±åƒ</div>
                            <div style="font-size:1.4rem; font-weight:900; color:#7a0000; text-align:center; border-top:1px solid #000; border-bottom:1px solid #000; padding:5px 0; margin-top:10px;">åˆå®‰Â·èˆ’å¿ƒ</div>
                        </div>
                    </div>
                </div>
            `;

            const sc = document.createElement('script');
            sc.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            document.head.appendChild(sc);

            let scale = 1, posX = 0, posY = 0, isDrag = false, sx, sy;
            const imgE = document.getElementById('img-e'), imgP = document.getElementById('img-p'), zoom = document.getElementById('zoom');
            
            const update = () => {
                const t = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
                imgE.style.transform = imgP.style.transform = t;
            };

            zoom.oninput = () => { scale = zoom.value; update(); };
            document.getElementById('cap-in').oninput = (e) => { document.getElementById('p-cap-out').innerText = e.target.value || "ä»Šæ—¥å½±åƒ"; };
            
            const v = document.getElementById('v-frame');
            v.ontouchstart = (e) => { isDrag = true; sx = e.touches[0].clientX - posX; sy = e.touches[0].clientY - posY; };
            window.ontouchmove = (e) => { if(!isDrag) return; posX = e.touches[0].clientX - sx; posY = e.touches[0].clientY - sy; update(); };
            window.ontouchend = () => isDrag = false;

            document.getElementById('p-date').innerText = new Date().toLocaleDateString('zh-TW', { year:'numeric', month:'long', day:'numeric'});
            fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=zh-TW%26gl=TW%26ceid=TW:zh-Hant')
            .then(r => r.json()).then(d => {
                document.getElementById('p-news').innerHTML = d.items.slice(0, 5).map(i => `<div class="news-item">${i.title.split(' - ')[0]}</div>`).join('');
            });
        }

        async function publish() {
            const btn = event.target; btn.innerText = "â³ åˆŠå°ä¸­...";
            const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
            try {
                const canvas = await html2canvas(document.getElementById('post-area'), { useCORS: true, scale: 2 });
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                const get = await fetch(url);
                const sha = get.ok ? (await get.json()).sha : null;
                await fetch(url, { method: "PUT", headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" }, body: JSON.stringify({ message: "Update", content: b64, sha }) });
                alert("âœ… åˆŠå°ç™¼å¸ƒæˆåŠŸï¼");
            } catch (e) { alert("ç™¼å¸ƒå¤±æ•—"); }
            btn.innerText = "â· ç¢ºå®šåˆŠå°ç™¼å¸ƒ";
        }
    </script>
</body>
</html>
