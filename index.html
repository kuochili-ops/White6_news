<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>白六日報 v14.2</title>
    <style>
        /* 1. 確保頁面沒有任何東西可以擋住點擊 */
        html, body { height: 100%; margin: 0; padding: 0; background: #000; color: #fff; text-align: center; }
        
        /* 2. 把按鈕做成實體、最原始的樣子，不套用複雜樣式 */
        .raw-button {
            display: block !important;
            width: 80% !important;
            height: 100px !important;
            margin: 50px auto !important;
            font-size: 20px !important;
            background: #ffffff !important;
            color: #000000 !important;
            border: 5px solid red !important; /* 紅邊框方便辨識 */
            z-index: 99999;
        }

        #editor-ui { display: none; padding: 10px; }
        .viewport { width: 200px; height: 200px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #333; }
        .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transform-origin: center; }
        .btn-pub { background: #27ae60; color: white; padding: 20px; width: 100%; border: none; font-size: 1.2rem; border-radius: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <h1 style="margin-top:20px;">1. 請點擊下方紅邊框</h1>
    
    <input type="file" id="upload" accept="image/*" class="raw-button">

    <div id="editor-ui">
        <h2>2. 調整並發布</h2>
        <div class="viewport" id="v-frame">
            <img id="img-prev" class="sync-img" src="">
        </div>
        <input type="range" id="zoom" min="0.1" max="4" step="0.01" value="1" style="width: 80%;">
        <button class="btn-pub" onclick="doUpload()">3. 確定刊印發布</button>
        
        <div id="capture-area" style="width:400px; background:#dbd0bc; color:#000; padding:20px; position:absolute; left:-9999px;">
            <h1 style="border-bottom:3px solid #000;">白六日報</h1>
            <div id="p-box" style="width:160px; height:160px; overflow:hidden; position:relative; border:1px solid #000;">
                <img id="img-final" class="sync-img" src="">
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const upload = document.getElementById('upload');
        const editor = document.getElementById('editor-ui');
        const imgPrev = document.getElementById('img-prev');
        const imgFinal = document.getElementById('img-final');
        const zoom = document.getElementById('zoom');

        let scale = 1;

        // 監聽檔案選擇
        upload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    imgPrev.src = imgFinal.src = ev.target.result;
                    editor.style.display = 'block';
                    upload.style.display = 'none'; // 選完才隱藏
                };
                reader.readAsDataURL(file);
            }
        });

        // 縮放邏輯
        zoom.oninput = function() {
            scale = zoom.value;
            const t = `translate(-50%, -50%) scale(${scale})`;
            imgPrev.style.transform = imgFinal.style.transform = t;
        };

        async function doUpload() {
            const btn = event.target;
            btn.innerText = "⏳ 發布中...";
            try {
                const canvas = await html2canvas(document.getElementById('p-box'));
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
                const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                const get = await fetch(url);
                const sha = get.ok ? (await get.json()).sha : null;
                const res = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update", content: b64, sha })
                });
                if (res.ok) alert("✅ 發布完成！");
            } catch (e) { alert("出錯了"); }
            btn.innerText = "3. 確定刊印發布";
        }
    </script>
</body>
</html>
