<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™½å…­æ—¥å ± v15.2</title>
    <style>
        /* åŸºç¤è¨­ç½®ï¼Œç¢ºä¿é é¢ä¸ç”¢ç”Ÿå¤šé¤˜ä½ç§» */
        body { background: #1a1a1a; color: #fff; margin: 0; font-family: sans-serif; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* å•Ÿå‹•éˆ•ï¼šåšå¤§ã€åšåšï¼Œç¢ºä¿ç¬¬ä¸€æ™‚é–“èƒ½é» */
        #init-box { margin-top: 60px; background: #222; padding: 40px 20px; border-radius: 20px; border: 4px solid #f39c12; width: 90%; text-align: center; box-sizing: border-box; }
        .big-up { width: 100%; height: 100px; background: #fff; color: #000; font-size: 1.5rem; font-weight: bold; border-radius: 15px; border: none; -webkit-appearance: none; }

        #app-body { display: none; width: 100%; max-width: 440px; }

        /* ç·¨è¼¯å€åŸŸï¼šæ¯å€‹å…ƒä»¶éƒ½ç”¨ margin æ’é–‹ï¼Œçµ•å°ä¸é‡ç–Š */
        .control-group { background: #333; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        .viewport { width: 200px; height: 200px; border: 2px solid #fff; margin: 0 auto; overflow: hidden; position: relative; background: #000; touch-action: none; }
        .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); pointer-events: none; }
        
        /* å¼·åŒ–å…ƒä»¶çš„ç¨ç«‹æ€§ */
        .touch-range { width: 100%; height: 60px; margin: 0; }
        .touch-input { width: 100%; height: 55px; padding: 0 15px; border-radius: 10px; border: none; font-size: 18px; box-sizing: border-box; background: #fff; color: #000; }
        .touch-btn { width: 100%; height: 75px; background: #27ae60; color: #fff; font-size: 1.4rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; -webkit-appearance: none; }

        /* å ±ç´™åº•ç¨¿æ¨£å¼ */
        .paper { background: #dbd0bc; color: #2a2825; padding: 25px; box-sizing: border-box; text-align: left; }
        .news-item { font-size: 0.85rem; margin-bottom: 6px; border-left: 3px solid #7a0000; padding-left: 8px; font-weight: bold; line-height: 1.4; }
    </style>
</head>
<body>

    <div id="init-box">
        <h2 style="color:#f39c12; margin-top:0;">ğ“ƒ¥ ç™½å…­æ—¥å ±ç³»çµ±</h2>
        <p style="margin-bottom:20px;">è«‹é»æ“Šç™½è‰²å€åŸŸé–‹å•Ÿç›¸ç‰‡</p>
        <input type="file" id="up" accept="image/*" class="big-up">
    </div>

    <div id="app-body">
        <div class="control-group">
            <div style="text-align:center; color:#f39c12; font-weight:bold;">â¶ èª¿æ•´ç…§ç‰‡ä½ç½®èˆ‡ç¸®æ”¾</div>
            <div class="viewport" id="v-frame">
                <img id="img-e" class="sync-img">
            </div>
            
            <input type="range" id="zoom" min="0.05" max="3" step="0.01" value="1" class="touch-range">
            <input type="text" id="cap-in" class="touch-input" placeholder="é»æ“Šæ­¤è™•è¼¸å…¥å ±ç´™åœ–èªª...">
            <button id="pub-btn" class="touch-btn">â· ç¢ºå®šåˆŠå°ç™¼å¸ƒ</button>
        </div>

        <div class="paper" id="post-area">
            <h1 style="text-align:center; font-size:3rem; margin:0 0 15px 0; border-bottom:4px solid #000;">ç™½å…­æ—¥å ±</h1>
            <div style="display:flex;">
                <div id="news-list" style="flex:1; border-right:1px solid #000; padding-right:10px;">æ–°èè¼‰å…¥ä¸­...</div>
                <div style="width:140px; padding-left:15px; text-align:center;">
                    <div style="width:140px; height:140px; border:1px solid #000; overflow:hidden; position:relative;">
                        <img id="img-p" class="sync-img">
                    </div>
                    <div id="p-cap" style="font-size:0.75rem; font-weight:bold; margin-top:5px;">ä»Šæ—¥å½±åƒ</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
        let scale = 1, posX = 0, posY = 0, isDrag = false, sx, sy;

        // å•Ÿå‹•èˆ‡ç…§ç‰‡è¼‰å…¥
        document.getElementById('up').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('img-e').src = document.getElementById('img-p').src = ev.target.result;
                document.getElementById('init-box').style.display = 'none';
                document.getElementById('app-body').style.display = 'block';
                fetchNews();
            };
            reader.readAsDataURL(file);
        };

        const imgE = document.getElementById('img-e'), imgP = document.getElementById('img-p');
        const updateTransform = () => {
            const t = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
            imgE.style.transform = imgP.style.transform = t;
        };

        // ç¸®æ”¾ç›£è½
        document.getElementById('zoom').addEventListener('input', (e) => {
            scale = e.target.value;
            updateTransform();
        });

        // æ‹–æ›³ç›£è½
        const vf = document.getElementById('v-frame');
        vf.addEventListener('touchstart', (e) => {
            isDrag = true;
            sx = e.touches[0].clientX - posX;
            sy = e.touches[0].clientY - posY;
        }, {passive: false});

        window.addEventListener('touchmove', (e) => {
            if (!isDrag) return;
            posX = e.touches[0].clientX - sx;
            posY = e.touches[0].clientY - sy;
            updateTransform();
        }, {passive: false});

        window.addEventListener('touchend', () => isDrag = false);

        // è¼¸å…¥ç›£è½
        document.getElementById('cap-in').oninput = (e) => {
            document.getElementById('p-cap').innerText = e.target.value || "ä»Šæ—¥å½±åƒ";
        };

        // æŠ“å–æ–°è
        async function fetchNews() {
            try {
                const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=zh-TW%26gl=TW%26ceid=TW:zh-Hant');
                const data = await res.json();
                document.getElementById('news-list').innerHTML = data.items.slice(0, 5).map(i => `<div class="news-item">${i.title.split(' - ')[0]}</div>`).join('');
            } catch(e) { document.getElementById('news-list').innerText = "æ–°èæš«æ™‚ç„¡æ³•è¼‰å…¥"; }
        }

        // ç™¼å¸ƒæŒ‰éˆ•
        document.getElementById('pub-btn').onclick = async function() {
            const btn = this;
            btn.innerText = "â³ åˆŠå°ä¸­...";
            btn.disabled = true;
            try {
                const canvas = await html2canvas(document.getElementById('post-area'), { useCORS: true, scale: 2 });
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                const res = await fetch(url);
                const sha = res.ok ? (await res.json()).sha : null;
                const put = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update Daily", content: b64, sha })
                });
                if (put.ok) alert("âœ… åˆŠå°ç™¼å¸ƒæˆåŠŸï¼");
                else alert("âŒ ç™¼å¸ƒå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯");
            } catch (e) { alert("å‡ºéŒ¯äº†: " + e); }
            btn.innerText = "â· ç¢ºå®šåˆŠå°ç™¼å¸ƒ";
            btn.disabled = false;
        };
    </script>
</body>
</html>
