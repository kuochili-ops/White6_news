<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½å…­æ—¥å ± v14.6</title>
</head>
<body style="background:#000; color:#fff; text-align:center; padding-top:50px;">

    <div id="init-box">
        <h1>ğ“ƒ¥ ç™½å…­æ—¥å ±ç³»çµ±</h1>
        <p>æ‰‹æ©Ÿè‹¥å¡ä½ï¼Œè«‹é»æ“Šä¸‹æ–¹åŸå§‹æŒ‰éˆ•ï¼š</p>
        <input type="file" id="up" accept="image/*" style="font-size:20px; padding:20px;">
    </div>

    <div id="app-body"></div>

    <script>
        const input = document.getElementById('up');
        
        // æ ¸å¿ƒé‚è¼¯ï¼šé¸å®Œç…§ç‰‡æ‰å•Ÿå‹•æ•´å€‹ App çš„ä»£ç¢¼
        input.onchange = function(e) {
            if(!e.target.files[0]) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                const imgData = ev.target.result;
                startApp(imgData);
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function startApp(imgSrc) {
            // 1. éš±è—å•Ÿå‹•éˆ•
            document.getElementById('init-box').style.display = 'none';

            // 2. æ³¨å…¥ CSS æ¨£å¼
            const style = document.createElement('style');
            style.innerHTML = `
                body { font-family: sans-serif; margin: 0; padding: 10px; background: #1a1a1a; }
                .edit-ui { background: #333; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
                .viewport { width: 180px; height: 180px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #000; }
                .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
                .paper { background: #dbd0bc; color: #2a2825; padding: 25px; font-family: serif; }
                .btn { background: #27ae60; color: white; padding: 15px; width: 100%; border: none; font-size: 1.2rem; border-radius: 10px; margin-top: 10px; }
            `;
            document.head.appendChild(style);

            // 3. æ³¨å…¥ App çµæ§‹
            document.getElementById('app-body').innerHTML = `
                <div class="edit-ui">
                    <b>ğŸ¨ èª¿æ•´å½±åƒèˆ‡åº•ç¨¿é€£å‹•</b>
                    <div class="viewport" id="v-frame">
                        <img id="img-e" class="sync-img" src="${imgSrc}">
                    </div>
                    <input type="range" id="zoom" min="0.1" max="4" step="0.01" value="1" style="width: 80%;">
                    <button class="btn" onclick="publish()">ç¢ºå®šåˆŠå°ç™¼å¸ƒ</button>
                </div>
                <div class="paper" id="post">
                    <h1 style="text-align:center; font-size:2.5rem; border-bottom:3px solid #000; margin:0;">ç™½å…­æ—¥å ±</h1>
                    <div style="display:flex; margin-top:15px;">
                        <div style="flex:1; border-right:1px solid #000; padding-right:10px;">
                            <p>ä»Šæ—¥å ±ç´™ç³»çµ±å·²ç©©å®šå•Ÿå‹•ã€‚</p>
                        </div>
                        <div style="width:160px; padding-left:10px;">
                            <div style="width:150px; height:150px; border:1px solid #000; overflow:hidden; position:relative;">
                                <img id="img-p" class="sync-img" src="${imgSrc}">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 4. å‹•æ…‹åŠ è¼‰æˆªåœ–å·¥å…·
            const sc = document.createElement('script');
            sc.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            document.head.appendChild(sc);

            // 5. ç¶å®šç¸®æ”¾åŠŸèƒ½
            const z = document.getElementById('zoom');
            z.oninput = () => {
                const s = z.value;
                document.getElementById('img-e').style.transform = `translate(-50%, -50%) scale(${s})`;
                document.getElementById('img-p').style.transform = `translate(-50%, -50%) scale(${s})`;
            };
        }

        async function publish() {
            const btn = event.target;
            btn.innerText = "â³ ç™¼å¸ƒä¸­...";
            const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
            try {
                const canvas = await html2canvas(document.getElementById('post'));
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                const get = await fetch(url);
                const sha = get.ok ? (await get.json()).sha : null;
                await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update", content: b64, sha })
                });
                alert("âœ… æˆåŠŸï¼");
            } catch (e) { alert("å¤±æ•—"); }
            btn.innerText = "ç¢ºå®šåˆŠå°ç™¼å¸ƒ";
        }
    </script>
</body>
</html>
