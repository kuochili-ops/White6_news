<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğ“ƒ¥ ç™½å…­æ—¥å ± - v14.5</title>
    <style>
        /* å•Ÿå‹•æ¨£å¼ï¼šæ¥µç°¡ï¼Œç¢ºä¿ä¸å¡é “ */
        body { background: #1a1a1a; color: white; margin: 0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        
        #launcher { 
            width: 85%; max-width: 400px; padding: 40px 20px; 
            border: 4px solid #f39c12; border-radius: 25px; text-align: center; background: #222; 
        }
        
        /* å”¯ä¸€çš„é»æ“Šç›®æ¨™ï¼šåŸç”Ÿå¤–è§€ï¼Œæ¬Šé™æœ€é«˜ */
        .big-launch-btn { 
            width: 100%; height: 90px; background: white; color: black; 
            font-size: 1.4rem; font-weight: bold; border-radius: 15px; border: none; cursor: pointer;
        }

        /* é è¨­éš±è—æ‰€æœ‰è¤‡é›œå€åŸŸ */
        #main-app { display: none; width: 100%; max-width: 440px; padding: 10px; }
        .edit-box { background: #333; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .viewport { width: 180px; height: 180px; border: 2px solid #fff; margin: 10px auto; overflow: hidden; position: relative; background: #000; touch-action: none; }
        .sync-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); transform-origin: center center; }
        
        /* å ±ç´™å€åŸŸ */
        .paper-content { background: #dbd0bc; color: #2a2825; padding: 25px; font-family: 'serif'; }
        .btn-pub { background: #27ae60; color: white; padding: 18px; width: 100%; border: none; font-size: 1.2rem; font-weight: bold; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="launcher">
        <h2 style="color:#f39c12; margin-top:0;">ğ“ƒ¥ ç™½å…­æ—¥å ±</h2>
        <p style="font-size: 0.9rem; color: #ccc;">è«‹é»æ“Šç™½è‰²å€å¡Šé¸å–ä»Šæ—¥ç…§ç‰‡</p>
        <input type="file" id="init-input" accept="image/*" class="big-launch-btn">
    </div>

    <div id="main-app">
        <div class="edit-box">
            <b>ğŸ¨ èª¿æ•´å½±åƒèˆ‡åº•ç¨¿é€£å‹•</b>
            <div class="viewport" id="v-frame">
                <img id="img-edit" class="sync-img" src="">
            </div>
            <input type="range" id="zoom-ctrl" min="0.1" max="4" step="0.01" value="1" style="width: 85%;">
            <input type="text" id="cap-input" placeholder="è¼¸å…¥åœ–èªª..." style="width:100%; padding:12px; margin-top:10px; box-sizing:border-box;">
            <button class="btn-pub" onclick="startPublish()" id="pub-btn">ç¢ºå®šåˆŠå°ç™¼å¸ƒ</button>
        </div>

        <div class="paper-content" id="capture-area">
            <h1 style="text-align:center; font-size:3rem; margin:0; border-bottom:4px solid #000;">ç™½å…­æ—¥å ±</h1>
            <div style="display:flex; margin-top:15px; gap:10px;">
                <div style="flex:1; font-size:0.85rem; border-right:1.5px solid #000; padding-right:10px;" id="news-feed">æ–°èè¼‰å…¥ä¸­...</div>
                <div style="width:160px;">
                    <div style="width:100%; height:160px; border:1px solid #000; overflow:hidden; position:relative;">
                        <img id="img-paper" class="sync-img" src="">
                    </div>
                    <div id="p-cap-out" style="text-align:center; font-size:0.75rem; font-weight:bold; margin-top:5px;">ä»Šæ—¥å½±åƒ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
        const CONF = { owner: "kuochili-ops", repo: "White6_news", path: "images/daily.jpg" };

        let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;
        const initInput = document.getElementById('init-input');
        const imgEdit = document.getElementById('img-edit');
        const imgPaper = document.getElementById('img-paper');

        // å•Ÿå‹•é‚è¼¯ï¼šç¬¬ä¸€æ™‚é–“åªç›£è½é€™å€‹
        initInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                // é¸å¥½ç…§ç‰‡ï¼Œç«‹åˆ»åˆ‡æ› UI
                imgEdit.src = imgPaper.src = ev.target.result;
                document.getElementById('launcher').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';

                // é€²å ´å¾Œæ‰å‹•æ…‹è¼‰å…¥é‡é‡ç´šè³‡æº
                const script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
                document.head.appendChild(script);
                
                fetchNews();
            };
            reader.readAsDataURL(file);
        };

        function refresh() {
            const t = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
            imgEdit.style.transform = imgPaper.style.transform = t;
        }

        document.getElementById('zoom-ctrl').oninput = (e) => { scale = e.target.value; refresh(); };
        document.getElementById('cap-input').oninput = (e) => { document.getElementById('p-cap-out').innerText = e.target.value || "ä»Šæ—¥å½±åƒ"; };

        const vFrame = document.getElementById('v-frame');
        vFrame.ontouchstart = (e) => { isDragging = true; startX = e.touches[0].clientX - posX; startY = e.touches[0].clientY - posY; };
        window.ontouchmove = (e) => { if (!isDragging) return; posX = e.touches[0].clientX - startX; posY = e.touches[0].clientY - startY; refresh(); };
        window.ontouchend = () => isDragging = false;

        function fetchNews() {
            fetch('https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss?hl=zh-TW%26gl=TW%26ceid=TW:zh-Hant')
            .then(r => r.json()).then(d => {
                document.getElementById('news-feed').innerHTML = d.items.slice(0, 4).map(i => `<p style="margin:5px 0;">â€¢ ${i.title.split(' - ')[0]}</p>`).join('');
            });
        }

        async function startPublish() {
            const btn = document.getElementById('pub-btn');
            btn.innerText = "â³ åˆŠå°ä¸­...";
            try {
                const canvas = await html2canvas(document.getElementById('capture-area'), { useCORS: true, scale: 2 });
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/${CONF.owner}/${CONF.repo}/contents/${CONF.path}`;
                const res = await fetch(url);
                const sha = res.ok ? (await res.json()).sha : null;
                await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update", content: b64, sha })
                });
                alert("âœ… åˆŠå°ç™¼å¸ƒæˆåŠŸï¼");
            } catch (e) { alert("ç™¼å¸ƒå¤±æ•—ï¼Œè«‹é‡è©¦"); }
            btn.innerText = "ç¢ºå®šåˆŠå°ç™¼å¸ƒ";
        }
    </script>
</body>
</html>
