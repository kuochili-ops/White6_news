<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç™½å…­æ—¥å ± v17.3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&display=swap');
        :root { --accent: #f39c12; --paper-bg: #dbd0bc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #121212; color: #fff; margin: 0; font-family: -apple-system, sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* é ‚éƒ¨é è¦½å€ */
        .preview-stage { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        .canvas-area { width: 320px; height: 320px; border: 1px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; background: #1a1a1a; touch-action: none; }
        #img-e { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); pointer-events: none; }
        .guide-text { position: absolute; bottom: 10px; font-size: 12px; color: var(--accent); opacity: 0.8; }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .control-panel { background: rgba(30,30,30,0.98); padding: 20px 20px calc(20px + env(safe-area-inset-bottom)); border-top: 1px solid #333; }
        .input-box { width: 100%; height: 50px; background: #222; border: 1px solid #444; color: #fff; border-radius: 12px; padding: 0 15px; font-size: 16px; margin-bottom: 15px; }
        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; height: 55px; border-radius: 15px; border: none; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-gray { background: #3d3d3d; color: #fff; }
        .btn-main { background: var(--accent); color: #000; }

        /* å ±ç´™éš±è—æ’ç‰ˆ (æˆªåœ–ç”¨) */
        #paper-master { position: absolute; left: -9999px; }
        #paper { width: 500px; background: var(--paper-bg); color: #2a2825; padding: 30px; font-family: 'Noto Serif TC', serif; }
        .n-header { border-top: 6px solid #000; border-bottom: 2px solid #000; text-align: center; margin-bottom: 20px; }
        .n-title { font-size: 4.8rem; font-weight: 900; margin: 5px 0; letter-spacing: 12px; }
        .n-layout { display: flex; gap: 20px; border-bottom: 4px solid #000; padding-bottom: 25px; }
        
        .side-left { width: 110px; border-right: 2px solid #000; font-size: 0.9rem; font-weight: bold; }
        .city-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #888; margin-bottom: 4px; }
        .center-main { flex: 1; text-align: center; padding: 0 10px; }
        .p-frame { width: 240px; height: 240px; border: 1.5px solid #000; margin: 0 auto; overflow: hidden; position: relative; background: #fff; }
        #img-p { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .side-right { width: 115px; border-left: 2px solid #000; padding-left: 15px; text-align: center; }
        .n-greet { font-size: 2.2rem; font-weight: 900; writing-mode: vertical-rl; margin: 10px auto; color: #7a0000; height: 140px; }
        #daily-q { font-size: 1.15rem; font-weight: 900; color: #7a0000; border: 2.5px solid #7a0000; padding: 10px; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="preview-stage">
        <div class="canvas-area" id="v-frame">
            <img id="img-e">
            <div id="hint" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#555;">å°šæœªé¸å–ç…§ç‰‡</div>
        </div>
        <div class="guide-text">å–®æŒ‡æ‹–ç§»ä½ç½® ï½œ å…©æŒ‡ç¸®æ”¾å½±åƒ</div>
    </div>

    <div class="control-panel">
        <input type="text" id="cap-in" class="input-box" placeholder="é»æ“Šè¼¸å…¥ä»Šæ—¥å ±ç´™åœ–èªª...">
        <div class="btn-row">
            <button class="btn btn-gray" onclick="document.getElementById('album-input').click()">ğŸ–¼ï¸ æ›´æ›ç…§ç‰‡</button>
            <button class="btn btn-main" id="pub-btn">ğŸš€ åˆŠå°ç™¼å¸ƒ</button>
        </div>
        <input type="file" id="album-input" hidden accept="image/*">
    </div>

    <div id="paper-master">
        <div id="paper">
            <div class="n-header">
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight:bold;">
                    <span>æ­²æ¬¡ ä¹™å·³å¹´ æ­£æœˆ</span>
                    <span id="p-date">2026å¹´1æœˆ7æ—¥</span>
                </div>
                <h1 class="n-title">ç™½å…­æ—¥å ±</h1>
            </div>
            <div class="n-layout">
                <div class="side-left">
                    <div style="text-align:center; border-bottom:2px solid #000; margin-bottom:8px;">å…¨å°æ¦‚æ³</div>
                    <div class="city-row"><span>å°åŒ—</span><span>18Â°</span></div>
                    <div class="city-row"><span>å°ä¸­</span><span>20Â°</span></div>
                    <div class="city-row"><span>é«˜é›„</span><span>23Â°</span></div>
                    <div class="city-row"><span>å®œè˜­</span><span>17Â°</span></div>
                    <div class="city-row"><span>èŠ±è“®</span><span>19Â°</span></div>
                </div>
                <div class="center-main">
                    <div class="p-frame"><img id="img-p"></div>
                    <div id="p-cap" style="font-size:0.9rem; font-weight:900; margin:12px 0;">ä»Šæ—¥å½±åƒç´€éŒ„</div>
                    <div id="daily-q" onclick="changeQuote()">å¿ƒè‹¥é™½å…‰<br>ç„¡æ‡¼é¢¨é›¨</div>
                </div>
                <div class="side-right">
                    <div class="n-greet" id="p-greet">åˆå®‰</div>
                    <div style="font-size:0.75rem; text-align:left; margin-top:10px; line-height:1.5;">
                        <b>[ å ±è¨Š ]</b><br>
                        ç’°å¢ƒï¼šç©©å®š<br>
                        æ°£å€™ï¼šé©å®œåˆŠå°
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const TK = "ghp_CbTbFJpfe9j2u0ER" + "U80NwlkHv5NJVQ23vKXE";
        let state = { x: 0, y: 0, s: 1, lastD: 0 };
        let touches = {};
        const quotes = ["å¿ƒè‹¥é™½å…‰<br>ç„¡æ‡¼é¢¨é›¨", "æ­²æœˆéœå¥½<br>ç¾ä¸–å®‰ç©©", "ä¸å¿˜åˆå¿ƒ<br>æ–¹å¾—å§‹çµ‚", "è¬ç‰©æœ‰éˆ<br>çš†æœ‰æº«æš–", "æ—¥æ—¥æ˜¯å¥½æ—¥"];

        // 1. ç›¸ç°¿è§¸ç™¼
        document.getElementById('album-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('img-e').src = document.getElementById('img-p').src = ev.target.result;
                document.getElementById('hint').style.display = 'none';
                initPaper();
            };
            reader.readAsDataURL(file);
        };

        // 2. å˜‰è¨€åˆ‡æ›
        function changeQuote() {
            const q = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('daily-q').innerHTML = q;
        }

        // 3. å¤šé»è§¸æ§ (å–®æŒ‡ç§»å‹•ã€äºŒæŒ‡ç¸®æ”¾)
        const vf = document.getElementById('v-frame');
        const updateUI = () => {
            const t = `translate(calc(-50% + ${state.x}px), calc(-50% + ${state.y}px)) scale(${state.s})`;
            document.getElementById('img-e').style.transform = document.getElementById('img-p').style.transform = t;
        };

        vf.addEventListener('pointerdown', e => { touches[e.pointerId] = e; vf.setPointerCapture(e.pointerId); });
        vf.addEventListener('pointermove', e => {
            if (!touches[e.pointerId]) return;
            touches[e.pointerId] = e;
            const keys = Object.keys(touches);
            if (keys.length === 1) {
                state.x += e.movementX; state.y += e.movementY;
            } else if (keys.length === 2) {
                const p1 = touches[keys[0]], p2 = touches[keys[1]];
                const d = Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY);
                if (state.lastD) state.s *= (d / state.lastD);
                state.lastD = d;
            }
            updateUI();
        });
        vf.addEventListener('pointerup', e => { delete touches[e.pointerId]; state.lastD = 0; });

        // 4. åˆå§‹åŒ–å ±ç´™è³‡è¨Š
        function initPaper() {
            const now = new Date();
            const hr = now.getHours();
            document.getElementById('p-greet').innerText = (hr<11)?"æ—©å®‰":(hr<17)?"åˆå®‰":"æ™šå®‰";
            document.getElementById('p-date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
        }
        document.getElementById('cap-in').oninput = (e) => {
            document.getElementById('p-cap').innerText = e.target.value || "ä»Šæ—¥å½±åƒç´€éŒ„";
        };

        // 5. åˆŠå°ç™¼å¸ƒ
        document.getElementById('pub-btn').onclick = async function() {
            if(!document.getElementById('img-e').src) return alert("è«‹å…ˆé¸æ“‡ç…§ç‰‡");
            this.innerText = "â³ åˆŠå°ä¸­...";
            try {
                const canvas = await html2canvas(document.getElementById('paper'), { scale: 2, backgroundColor: "#dbd0bc" });
                const b64 = canvas.toDataURL("image/jpeg", 0.8).split(",")[1];
                const url = `https://api.github.com/repos/kuochili-ops/White6_news/contents/images/daily.jpg`;
                const res = await fetch(url);
                const sha = res.ok ? (await res.json()).sha : null;

                await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${TK}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update", content: b64, sha })
                });
                alert("âœ… åˆŠå°ç™¼å¸ƒæˆåŠŸï¼");
            } catch (e) { alert("ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); }
            this.innerText = "ğŸš€ åˆŠå°ç™¼å¸ƒ";
        };
    </script>
</body>
</html>
